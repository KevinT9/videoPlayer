<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproductor de Video</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
    <style>
        :root {
            --color-1: #0a161d;
            --color-2: #173343;
            --color-3: #245069;
            --color-4: #606060;
            --color-5: #797979;
        }

        body {
            background-color: var(--color-1);
            color: #fff;
            font-family: Arial, sans-serif;
        }

        header {
            background-color: var(--color-2);
            padding: 1rem;
            text-align: center;
        }

        #mainContainer {
            display: flex;
            flex-direction: row;
            gap: 1rem;
            margin: 1rem;
        }

        #videoPlayerContainer {
            flex: 3;
            background-color: var(--color-3);
            padding: 1rem;
            border-radius: 8px;
        }

        #videoPlayer {
            width: 100%;
            border-radius: 8px;
        }

        #chatContainer {
            flex: 1;
            background-color: var(--color-3);
            padding: 1rem;
            border-radius: 8px;
            max-height: 600px;
            overflow-y: auto;
        }

        #chatMessages {
            list-style-type: none;
            padding: 0;
        }

        #chatMessages li {
            background-color: var(--color-4);
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 4px;
        }

        #chatInput {
            width: calc(100% - 70px);
            margin-right: 10px;
            border: none;
            border-radius: 4px;
            padding: 0.5rem;
        }

        #videoList {
            background-color: var(--color-2);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem;
        }

        #videoList a {
            display: block;
            color: #fff;
            text-decoration: none;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background-color: var(--color-3);
            border-radius: 4px;
        }

        #videoList a:hover {
            background-color: var(--color-4);
        }
    </style>
</head>
<body>

<header>
    <h1>Reproductor de Video</h1>
    <span id="visitante" th:text="${visitante}" style="display: none"></span>
    <p>Sesión actual: <span id="sessionId" th:text="${sesion.getSessionId()}"></span></p>
    <p>Usuario: <span id="username" th:text="${sesion.getNombre()}"></span></p>
</header>

<div id="mainContainer">
    <!-- Sección principal de video -->
    <section id="videoPlayerContainer">
        <h2 id="nombreVideo">Esperando el video...</h2>
        <video id="videoPlayer" controls>
            <source id="videoSource" type="video/mp4">
            Tu navegador no soporta el formato de video.
        </video>
        <div class="d-flex justify-content-between mt-2">
            <button id="btnAnterior" class="btn btn-primary">Anterior</button>
            <button id="btnSiguiente" class="btn btn-primary">Siguiente</button>
        </div>
    </section>

    <!-- Sección de chat -->
    <section id="chatContainer">
        <h2>Chat</h2>
        <ul id="chatMessages"></ul>
        <div class="d-flex">
            <input type="text" id="chatInput" placeholder="Escribe un mensaje...">
            <button class="btn btn-success" onclick="sendMessage()">Enviar</button>
        </div>
    </section>
</div>

<section id="videoList">
    <div id="buscarVideo">
        <input type="text" id="busqueda" placeholder="Buscar video...">
        <button class="btn btn-primary" onclick="buscarVideo()">Buscar</button>
    </div>
    <h3>Selecciona un video:</h3>
    <!-- Los videos se cargarán aquí dinámicamente -->
</section>
<script th:src="@{/js/handleVideo.js}"></script>
<script>

    let busqueda = document.getElementById('busqueda');
    busqueda.addEventListener('keyup', buscarVideo);

    function buscarVideo() {
        const input = document.getElementById('busqueda').value;
        const videos = document.querySelectorAll('#videoList a');

        videos.forEach(video => {
            const videoName = video.innerText.toLowerCase();
            const videoElement = video;

            if (videoName.includes(input.toLowerCase())) {
                videoElement.style.display = 'block';
            } else {
                videoElement.style.display = 'none';
            }
        });
    }

    const url = new URL(window.location.href);
    const urlBase = url.host;
    console.log("urlBase:", urlBase);

    let socket = null;
    let stompClient = null;
    let isUserInteracting = false;

    /**
     * Conecta al WebSocket y se suscribe al canal usando el sessionId.
     */
    function connectToWebSocket(sessionId, username) {
        const nombreVideo = document.getElementById('nombreVideo');

        socket = new SockJS(`https://${urlBase}/ws/video`);
        stompClient = Stomp.over(socket);

        stompClient.connect({}, (frame) => {
            console.log('Conectado a WebSocket:', frame);

            let visitante = document.getElementById('visitante').innerText;
            let type = visitante === "false" ? "registerSession" : "addUser";

            // Registrar sesión en el servidor
            stompClient.send("/app/connect", {}, JSON.stringify({
                type,
                sessionId,
                username,
                message: `${username} se ha unido a la sesión.`
            }));

            // Suscripción al canal
            stompClient.subscribe(`/topic/${sessionId}`, (message) => {
                handleIncomingMessage(JSON.parse(message.body));
            });
        });

        /** Maneja mensajes entrantes del WebSocket */
        function handleIncomingMessage(message) {

            switch (message.type) {
                case "addUser":
                case "chatMessage":
                    appendChatMessage(message);
                    break;

                case "videoLoad":
                case "previousVideo":
                case "nextVideo":
                    loadVideo(message);
                    break;

                case "videoPause":
                    controlVideoPlayback(false, message.video.currentTime);
                    break;

                case "videoPlay":
                    controlVideoPlayback(true, message.video.currentTime);
                    break;

                case "videoState":
                    syncVideoState(message);
                    break;
            }
        }

        function appendChatMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const li = document.createElement('li');
            li.innerText = message.type === "addUser"
                ? `Se unió el usuario: ${message.username}`
                : `${message.username}: ${message.message}`;
            chatMessages.appendChild(li);
        }

        function loadVideo(message) {
            nombreVideo.innerText = message.video.nameVideo;
            const videoPlayer = document.getElementById('videoPlayer');
            const videoSource = document.getElementById('videoSource');

            videoSource.src = message.video.videoUrl;
            videoPlayer.currentTime = message.video.currentTime;
            videoPlayer.volume = 0.3;
            videoPlayer.load();
            videoPlayer.play();

            setNavigationButtons(message.video.nameVideo);
        }

        function setNavigationButtons(currentVideo) {
            document.getElementById("btnAnterior").onclick = () => cargarVideo("previousVideo", currentVideo);
            document.getElementById("btnSiguiente").onclick = () => cargarVideo("nextVideo", currentVideo);
        }

        function controlVideoPlayback(isPlaying, currentTime) {
            const videoPlayer = document.getElementById('videoPlayer');
            videoPlayer.currentTime = currentTime;
            isPlaying ? videoPlayer.play() : videoPlayer.pause();
        }

        function syncVideoState(message) {
            const videoPlayer = document.getElementById('videoPlayer');
            const videoSource = document.getElementById('videoSource');

            videoSource.src = message.video.videoUrl;
            videoPlayer.currentTime = message.video.currentTime;

            message.video.isPlaying ? videoPlayer.play() : videoPlayer.pause();
        }
    }

    /**
     * Inicia la sesión del usuario y conecta al WebSocket.
     */
    function registerSession() {
        const sessionId = document.getElementById('sessionId').innerText;
        let username = document.getElementById('username').innerText;

        if (!username) {
            username = prompt("Ingresa tu nombre de usuario:");
            document.getElementById('username').innerText = username;
        }

        connectToWebSocket(sessionId, username);
    }

    /**
     * Enviar mensaje al servidor.
     */
    function sendMessage() {
        const message = document.getElementById('chatInput').value;
        const sessionId = document.getElementById('sessionId').innerText;

        stompClient.send("/app/connect", {}, JSON.stringify({
            type: "chatMessage",
            sessionId,
            username: document.getElementById('username').innerText,
            message
        }));

        document.getElementById('chatInput').value = '';
    }

    /**
     * Enviar estado del video al servidor.
     */
    function sendVideoState(action) {
        const sessionId = document.getElementById('sessionId').innerText;
        const videoElement = document.getElementById("videoPlayer");
        const videoUrl = document.getElementById("videoSource").src.replace(`https://${urlBase}`, "");

        stompClient.send("/app/connect", {}, JSON.stringify({
            type: action,
            sessionId,
            username: document.getElementById('username').innerText,
            video: {
                videoUrl,
                currentTime: videoElement.currentTime,
                isPlaying: !videoElement.paused
            }
        }));
    }

    /**
     * Cargar un video (anterior o siguiente).
     */
    function cargarVideo(action, filename) {
        const sessionId = document.getElementById('sessionId').innerText;

        stompClient.send("/app/connect", {}, JSON.stringify({
            type: action,
            sessionId,
            username: document.getElementById('username').innerText,
            video: {
                videoUrl: `/videos/${filename}`,
                currentTime: 0,
                isPlaying: false,
                nameVideo: filename
            }
        }));
    }

    // Event Listeners
    registerSession();

    const videoPlayer = document.getElementById("videoPlayer");

    videoPlayer.addEventListener("seeking", () => isUserInteracting = true);
    videoPlayer.addEventListener("seeked", () => isUserInteracting = false);

    videoPlayer.addEventListener("play", () => {
        if (!isUserInteracting) sendVideoState("videoPlay");
    });

    videoPlayer.addEventListener("pause", () => {
        if (!isUserInteracting) sendVideoState("videoPause");
    });

    videoPlayer.addEventListener("ended", () => {
        const nombreVideo = document.getElementById('nombreVideo').innerText;
        cargarVideo("nextVideo", nombreVideo);
    });

    cargarListaVideos();
</script>


</body>
</html>
