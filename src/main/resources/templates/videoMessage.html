<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproductor de Video</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
</head>
<body>

<h1>Reproductor de Video</h1>
<span id="visitante" th:text="${visitante}" style="display: none"></span>
<p>Sesión actual: <span id="sessionId" th:text="${sesion.getSessionId()}"></span></p>
<p>Usuario: <span id="username" th:text="${sesion.getNombre()}"></span></p>

<section id="videoPlayerContainer">
<!--    Titulo del video-->
    <h2 id="nombreVideo">Esperando el video...</h2>
    <video id="videoPlayer" width="1080" controls>
        <source id="videoSource" type="video/mp4">
        Tu navegador no soporta el formato de video.
    </video>
    <div id="videoControls">
        <button id="btnAnterior">Anterior</button>
        <button id="btnSiguiente">Siguiente</button>
    </div>
</section>

<section id="chatContainer">
    <h2>Chat</h2>
    <ul id="chatMessages"></ul>
    <input type="text" id="chatInput" placeholder="Escribe un mensaje...">
    <button onclick="sendMessage()">Enviar</button>
</section>

<script>

    const url = new URL(window.location.href);
    const urlBase = url.host;
    console.log("urlBase:", urlBase);

    let socket = null;
    let stompClient = null;
    let isUserInteracting = false;

    /**
     * Conecta al WebSocket y se suscribe al canal usando el sessionId.
     */
    function connectToWebSocket(sessionId, username) {
        const nombreVideo = document.getElementById('nombreVideo');

        socket = new SockJS(`https://${urlBase}/ws/video`);
        stompClient = Stomp.over(socket);

        stompClient.connect({}, (frame) => {
            console.log('Conectado a WebSocket:', frame);

            let visitante = document.getElementById('visitante').innerText;
            let type = visitante === "false" ? "registerSession" : "addUser";

            // Registrar sesión en el servidor
            stompClient.send("/app/connect", {}, JSON.stringify({
                type,
                sessionId,
                username,
                message: `${username} se ha unido a la sesión.`
            }));

            // Suscripción al canal
            stompClient.subscribe(`/topic/${sessionId}`, (message) => {
                handleIncomingMessage(JSON.parse(message.body));
            });
        });

        /** Maneja mensajes entrantes del WebSocket */
        function handleIncomingMessage(message) {


            switch (message.type) {
                case "addUser":
                case "chatMessage":
                    appendChatMessage(message);
                    break;

                case "videoLoad":
                case "previousVideo":
                case "nextVideo":
                    loadVideo(message);
                    break;

                case "videoPause":
                    controlVideoPlayback(false, message.video.currentTime);
                    break;

                case "videoPlay":
                    controlVideoPlayback(true, message.video.currentTime);
                    break;

                case "videoState":
                    syncVideoState(message);
                    break;
            }
        }

        function appendChatMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const li = document.createElement('li');
            li.innerText = message.type === "addUser"
                ? `Se unió el usuario: ${message.username}`
                : `${message.username}: ${message.message}`;
            chatMessages.appendChild(li);
        }

        function loadVideo(message) {
            nombreVideo.innerText = message.video.nameVideo;
            const videoPlayer = document.getElementById('videoPlayer');
            const videoSource = document.getElementById('videoSource');

            videoSource.src = message.video.videoUrl;
            videoPlayer.currentTime = message.video.currentTime;
            videoPlayer.volume = 0.3;
            videoPlayer.load();
            videoPlayer.play();

            setNavigationButtons(message.video.nameVideo);
        }

        function setNavigationButtons(currentVideo) {
            document.getElementById("btnAnterior").onclick = () => cargarVideo("previousVideo", currentVideo);
            document.getElementById("btnSiguiente").onclick = () => cargarVideo("nextVideo", currentVideo);
        }

        function controlVideoPlayback(isPlaying, currentTime) {
            const videoPlayer = document.getElementById('videoPlayer');
            videoPlayer.currentTime = currentTime;
            isPlaying ? videoPlayer.play() : videoPlayer.pause();
        }

        function syncVideoState(message) {
            const videoPlayer = document.getElementById('videoPlayer');
            const videoSource = document.getElementById('videoSource');

            videoSource.src = message.video.videoUrl;
            videoPlayer.currentTime = message.video.currentTime;

            message.video.isPlaying ? videoPlayer.play() : videoPlayer.pause();
        }
    }

    /**
     * Inicia la sesión del usuario y conecta al WebSocket.
     */
    function registerSession() {
        const sessionId = document.getElementById('sessionId').innerText;
        let username = document.getElementById('username').innerText;

        if (!username) {
            username = prompt("Ingresa tu nombre de usuario:");
            document.getElementById('username').innerText = username;
        }

        connectToWebSocket(sessionId, username);
    }

    /**
     * Enviar mensaje al servidor.
     */
    function sendMessage() {
        const message = document.getElementById('chatInput').value;
        const sessionId = document.getElementById('sessionId').innerText;

        stompClient.send("/app/connect", {}, JSON.stringify({
            type: "chatMessage",
            sessionId,
            username: document.getElementById('username').innerText,
            message
        }));
    }

    /**
     * Enviar estado del video al servidor.
     */
    function sendVideoState(action) {
        const sessionId = document.getElementById('sessionId').innerText;
        const videoElement = document.getElementById("videoPlayer");
        const videoUrl = document.getElementById("videoSource").src.replace(`https://${urlBase}`, "");

        stompClient.send("/app/connect", {}, JSON.stringify({
            type: action,
            sessionId,
            username: document.getElementById('username').innerText,
            video: {
                videoUrl,
                currentTime: videoElement.currentTime,
                isPlaying: !videoElement.paused
            }
        }));
    }

    /**
     * Cargar un video (anterior o siguiente).
     */
    function cargarVideo(action, filename) {
        const sessionId = document.getElementById('sessionId').innerText;

        stompClient.send("/app/connect", {}, JSON.stringify({
            type: action,
            sessionId,
            username: document.getElementById('username').innerText,
            video: {
                videoUrl: `/videos/${filename}`,
                currentTime: 0,
                isPlaying: false,
                nameVideo: filename
            }
        }));
    }

    // Event Listeners
    registerSession();

    const videoPlayer = document.getElementById("videoPlayer");

    videoPlayer.addEventListener("seeking", () => isUserInteracting = true);
    videoPlayer.addEventListener("seeked", () => isUserInteracting = false);

    videoPlayer.addEventListener("play", () => {
        if (!isUserInteracting) sendVideoState("videoPlay");
    });

    videoPlayer.addEventListener("pause", () => {
        if (!isUserInteracting) sendVideoState("videoPause");
    });

    videoPlayer.addEventListener("ended", () => {
        const nombreVideo = document.getElementById('nombreVideo').innerText;
        cargarVideo("nextVideo", nombreVideo);
    });


</script>

</body>
</html>
